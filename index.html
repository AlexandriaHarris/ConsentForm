<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consent Builder – Single‑file HTML (Aligned v5)</title>
  <style>
    :root { --bg:#f7f7fb; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--ink);background:linear-gradient(#fafafa,#f2f4f8)}
    h1,h2,h3{margin:0 0 .5rem}
    .app{max-width:1120px;margin:0 auto;padding:1rem}
    .topbar{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:50}
    .topbar .inner{display:flex;align-items:center;justify-content:space-between;gap:.75rem;padding:.5rem 1rem}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer;font-weight:600}
    .btn.primary{background:#111827;color:#fff;border-color:#111827}
    .btn:active{transform:translateY(1px)}
    .grid{display:grid;grid-template-columns:minmax(0,440px) 1fr;gap:1rem;margin:1rem auto}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{background:#fff;border:1px solid var(--border);border-radius:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card>.hd{padding:.75rem 1rem;border-bottom:1px solid var(--border);font-weight:700}
    .card>.bd{padding:1rem}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:.75rem;color:var(--muted);margin:.25rem 0}
    input[type=text], textarea{width:100%;padding:.6rem .65rem;border:1px solid var(--border);border-radius:.5rem;background:#fff}
    textarea{resize:vertical}
    .muted{color:var(--muted)}
    .list{display:grid;gap:.5rem}
    .check{display:flex;align-items:flex-start;gap:.5rem;font-size:.9rem}
    .check input{margin-top:.25rem}
    .border{border:1px solid var(--border);border-radius:.5rem;padding:.75rem}
    .actions{display:flex;gap:.5rem;align-items:center}

    /* Print preview side */
    .sheet{position:relative;width:8.5in;height:11in;background:#fff;margin:0 auto;border:1px solid var(--border);box-shadow:0 3px 24px rgba(0,0,0,.12)}

    /* HEADER layout */
    .header{position:absolute;left:0;right:0;top:0;height:1.25in;border-bottom:1px solid #000}
    .hdr{display:grid;grid-template-columns:1.6in 1fr;height:100%;padding:.25in .5in .2in .5in;column-gap:.3in;align-items:end}
    .hdr-left{display:flex;flex-direction:column;justify-content:space-between;align-items:flex-start}
    .hdr-right{font:10pt "Times New Roman",Times,serif;line-height:1.1;text-align:right}
    .pageNo{font:10pt "Times New Roman",Times,serif}
    .logo{height:.55in;width:auto;display:block}
    .line{display:inline-block;min-width:10ch}

    /* FOOTER minimal */
    .footer {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  height: 0.5in; /* Fixed footer height */
  border-top: 1px solid #000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 0.5in;
  font-size: 9pt;
  page-break-inside: avoid; /* Prevent footer from breaking */
}
    .barcode{height:.45in;width:auto}
    .foot-date{font:10pt "Times New Roman",Times,serif}

    /* BODY */
    /*
     * The content area needs to leave enough room at the bottom of each
     * sheet so the text never overflows into the footer when the form is
     * populated with variable‑length user input.  Increasing the bottom
     * inset from 1.15in to 1.25in and slightly tightening the line height
     * provides extra breathing room and keeps the printed page close to
     * true US Letter dimensions without pushing content off the page.
     *
     * Further adjustments: to ensure that text never encroaches into the
     * footer even with variable-length user input, we shorten the content
     * area further (bottom inset 1.8in) and add extra bottom padding.
     * A tighter line height helps fit the fixed wording comfortably.
     */
    /*
     * The content area needs generous space at the bottom to keep text from
     * spilling into the footer.  Increasing the bottom inset ensures that
     * even lengthy auto‑populated fields (for example, treatment
     * alternatives or procedure‑specific risks) remain clear of the footer.
     * The line height is slightly tightened so the fixed wording still
     * fits comfortably on the page.  If further padding is required,
     * increase the bottom value again.
     */
    /* Increase bottom inset slightly to provide more breathing room
       at the bottom of the page.  A larger bottom value prevents
       long paragraphs from running into the footer, especially when
       dynamic fields contain a lot of text. */
    /* The main content area sits between the header and footer.  Increase
     * the bottom inset slightly to ensure that long paragraphs do not
     * encroach on the footer when printed. */
.content {
  position: absolute;
  left: 0.5in;
  right: 0.5in;
  top: 1.25in;
  bottom: 1in; /* Increased from 0.5in to make room for footer */
  padding: 0;
  font: 11pt "Times New Roman", Times, serif;
  line-height: 1.15;
  overflow: hidden; /* Prevent content from overflowing */
}
    .title{font-weight:700;text-align:center;margin:.15in 0;font-size:12pt}
    .small{font-size:9pt;text-align:center}
    .ol{padding-left:.25in}
    .ol li{margin:.08in 0}

    /* Add to your existing CSS */
.ol, .dash, p {
  page-break-inside: avoid; /* Keep elements from splitting across pages */
}

/* Adjust your dash elements */
.dash {
  min-height: 0.5rem;
  border-bottom: 1px solid #000;
  padding-bottom: 0.2rem;
  white-space: pre-wrap;
  page-break-inside: avoid;
}

    /* WITNESS/SIGNATURE BLOCK */
    .siggrid{display:grid;grid-template-columns:auto 1fr;column-gap:.2in;row-gap:.14in;font-size:10pt}
    .siggrid .label{white-space:nowrap}
    /* A generic underline used for fill‑in blanks.  We deliberately avoid
     * setting a min‑height or vertical offset here because those can
     * inadvertently draw two parallel lines when nested inside other
     * containers.  A simple 1px bottom border creates a single, crisp line.
     * The width of the blank is controlled via additional classes (e.g.
     * u-date-time, u-med, u-rel, etc.). */
    .uline{display:inline-block;border-bottom:1px solid #000;padding-bottom:0;vertical-align:baseline}
    .u-wide{min-width:3.2in}
    .u-med{min-width:2.0in}
    .u-short{min-width:1.2in}
    .u-rel{min-width:3.2in}

    /* narrower line used for date and time fields in the signature section.  A
     * width of about three‑quarters of an inch keeps the date/time blanks
     * compact so they don't visually compete with the longer signature line. */
    .u-date-time{min-width:0.75in}

    /* Signature section flex layout
     * The signature rows consist of up to three fields (Date, Time, and Signature).
     * Without explicit layout rules, each field would stack vertically, leading to
     * unwanted extra blank lines.  Define row and field containers using flexbox
     * so the items sit on a single line.  The gap values are tuned to roughly
     * match the spacing in the original PDF.  Flex‑grow lets the long
     * signature label and line expand to fill the remaining space, while
     * narrower date/time fields remain compact.  See the markup in the
     * signature section (page 4) for usage.
     */
    .signature-row{display:flex;gap:.25in;align-items:baseline;margin:.05in 0;font-size:10pt}
    .sig-field{display:flex;gap:.05in;align-items:baseline}
    .flex-grow{flex:1 1 auto}

    /* Field container for inline blanks with a label underneath.  This is used
     * on page 1 for the “Name of patient or Designee” and “Name of Patient”
     * blanks.  Remove extra padding that could create a second line under
     * the blank; the line itself comes from the border-bottom.  The
     * line height is kept modest to align the text with the surrounding
     * paragraph. */
    .field-container{display:inline-block;position:relative;border-bottom:1px solid #000;min-width:3in;padding-bottom:0;line-height:1.1}
    .field-container .field-text{display:inline-block}
    /* Position the label just below the underline.  The 14px offset roughly
     * corresponds to the height of the text above plus a small gap. */
    .field-container .field-label{position:absolute;top:14px;left:0;right:0;font-size:7pt;text-align:center;line-height:1}

    /* Print controls */
    @page {
  size: letter; /* Explicitly set to US Letter size */
  margin: 0; /* Remove default margins */
}

.sheet {
  width: 100%; /* Use full page width */
  height: auto; /* Let content determine height */
  min-height: 11in; /* Minimum height of letter paper */
  page-break-after: always; /* Keep existing page breaks */
  overflow: hidden; /* Prevent content spillover */
}
    @media print {
  body {
    background: #fff;
    margin: 0;
    padding: 0;
    width: 100%;
  }
  
  .sheet {
    width: 100%;
    height: 11in;
    margin: 0;
    padding: 0;
    border: none;
    box-shadow: none;
    page-break-after: always;
  }
  
  .no-print {
    display: none !important;
  }
  
  /* Ensure images print properly */
  img {
    max-width: 100%;
    height: 80%;
    print-color-adjust: exact;
    -webkit-print-color-adjust: exact;
  }
  
  /* Force footer to bottom */
  @page :footer {
    display: none;
  }
  @page :header {
    display: none;
  }
}
    
  </style>
</head>
<body>
  <div class="topbar no-print">
    <div class="inner">
      <div><strong>Consent Builder</strong> — Single‑file HTML (aligned v5)</div>
      <div class="actions">
        <button id="resetBtn" class="btn">Reset</button>
        <button id="printBtn" class="btn primary">Print / Save PDF</button>
      </div>
    </div>
  </div>

  <div class="app">
    <div class="grid">
      <!-- Left: Human Interface -->
      <div class="left no-print" id="left">
        <div class="card">
          <div class="hd">Patient & Surgeons</div>
          <div class="bd">
            <div class="row">
              <div>
                <label for="patientName">Patient Name</label>
                <input type="text" id="patientName" data-field="patientName" />
              </div>
              <div>
                <label for="dob">Date of Birth</label>
                <input type="text" id="dob" data-field="dob" placeholder="MM/DD/YYYY" />
              </div>
              <div>
                <label for="idNumber">MRN / Identification Number</label>
                <input type="text" id="idNumber" data-field="idNumber" />
              </div>
              <div>
                <label for="facility">Facility</label>
                <input type="text" id="facility" data-field="facility" />
              </div>
              <div>
                <label for="designeeName">Name of patient or Designee (signer)</label>
                <input type="text" id="designeeName" data-field="designeeName" />
              </div>
              <div>
                <label for="consentForName">Name of Patient (if signer is a designee)</label>
                <input type="text" id="consentForName" data-field="consentForName" />
              </div>
            </div>

            <div style="margin-top:.75rem">
              <div style="font-weight:600;margin-bottom:.25rem">Select surgeon(s)</div>
              <div id="surgeonList" class="list"></div>
              <div class="actions" style="margin-top:.5rem">
                <input id="newSurgeon" type="text" placeholder="Add surgeon full name" />
                <button class="btn" id="addSurgeonBtn">Add</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem">
          <div class="hd">Procedures (multi‑select) & Risk Library</div>
          <div class="bd">
            <div id="procList" class="list"></div>
            <!-- Laterality controls for procedures that require it -->
            <div id="lateralitySection" class="list" style="margin-top:.5rem; display:none"></div>
            <div class="border" style="margin-top:.75rem">
              <div style="font-weight:600;margin-bottom:.25rem">Add a procedure</div>
              <div class="list">
                <input id="procName" type="text" placeholder="Procedure name" />
                <textarea id="procRisks" rows="3" placeholder="Risks (comma or newline separated)"></textarea>
                <!-- new field to capture alternatives for a procedure -->
                <textarea id="procAlts" rows="2" placeholder="Alternatives (comma or newline separated)"></textarea>
                <!-- checkbox to mark whether the new procedure requires laterality -->
                <label style="display:flex;align-items:center;font-size:.75rem"><input type="checkbox" id="procLaterality" style="margin-right:.25rem">Requires laterality (L/R/B)</label>
                <div style="text-align:right"><button class="btn" id="addProcBtn">Add to Catalog</button></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem">
          <div class="hd">Auto‑populated Fields (editable)</div>
          <div class="bd list">
            <div>
              <label for="diagnosis">Diagnosis</label>
              <textarea id="diagnosis" data-field="diagnosis" rows="3"></textarea>
            </div>
            <div>
              <label for="recommendedProcedure">Recommended Procedure (auto from selection — you can edit)</label>
              <textarea id="recommendedProcedure" data-field="recommendedProcedure" rows="2"></textarea>
            </div>
              <div>
                <label for="alternatives">Treatment Alternatives (auto from selection — you can edit)</label>
                <!-- reduce rows to 2 to save space as requested -->
                <textarea id="alternatives" data-field="alternatives" rows="2"></textarea>
              </div>
            <div>
              <label for="otherRisks">Other risks (auto from selection — you can edit)</label>
              <textarea id="otherRisks" data-field="otherRisks" rows="4"></textarea>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem">
          <div class="hd">Signatures & Times</div>
          <div class="bd">
            <div class="row">
              <!-- Row 1: unified signature date and signer time -->
              <div>
                <label for="signerDate">Signature Date (MM/DD/YYYY)</label>
                <input type="text" id="signerDate" data-field="signerDate" />
              </div>
              <div>
                <label for="signerTime">Signer Time (HH:MM)</label>
                <input type="text" id="signerTime" data-field="signerTime" />
              </div>
              <!-- Row 2: signer name and relationship -->
              <div>
                <label for="signerName">Printed name — patient or authorized person</label>
                <input type="text" id="signerName" data-field="signerName" />
              </div>
              <div>
                <label for="signerRelationship">Relationship to patient (if not patient)</label>
                <input type="text" id="signerRelationship" data-field="signerRelationship" />
              </div>
              <!-- Row 3: witness name and witness time -->
              <div>
                <label for="witnessName">Witness (printed name)</label>
                <input type="text" id="witnessName" data-field="witnessName" />
              </div>
              <div>
                <label for="witnessTime">Witness Time</label>
                <input type="text" id="witnessTime" data-field="witnessTime" />
              </div>
              <!-- Row 4: physician name and physician time -->
              <div>
                <label for="physSigName">Physician/Representative (printed name)</label>
                <input type="text" id="physSigName" data-field="physSigName" />
              </div>
              <div>
                <label for="physSigTime">Physician/Rep Time</label>
                <input type="text" id="physSigTime" data-field="physSigTime" />
              </div>
              <!-- Row 5: interpreter fields -->
              <div>
                <label for="cyracom">Interpreter Cyracom ID (if applicable)</label>
                <input type="text" id="cyracom" data-field="cyracom" />
              </div>
              <div>
                <label for="interpName">Interpreter Print Name</label>
                <input type="text" id="interpName" data-field="interpName" />
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:1rem">
          <div class="hd">Selected Text — Review before printing</div>
          <div class="bd">
            <textarea id="reviewBox" rows="10" readonly style="width:100%"></textarea>
            <div class="actions" style="margin-top:.5rem">
              <button id="copyBtn" class="btn">Copy for Note</button>
              <div class="muted" style="font-size:.8rem">This box is for quick review and can be copied into your documentation. Printing uses the PDF layout on the right.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Print Preview (exact wording/pages) -->
      <div class="right" style="overflow:auto;min-width:0">
        <!-- PAGE 1 -->
        <div class="sheet">
          <div class="header">
            <div class="hdr">
              <div class="hdr-left">
                <div class="pageNo">Page 1 of 4</div>
                <img class="logo" src="gTlSit7.png" alt="UPMC" />
              </div>
              <div class="hdr-right">
                <div><strong>Patient Name:</strong> <span class="hdrPatientName line"></span></div>
                <div><strong>Identification Number:</strong> <span class="hdrId line"></span></div>
                <div><strong>Date of Birth:</strong> <span class="hdrDob line"></span></div>
                <div><strong>Facility:</strong> <span class="hdrFacility line"></span></div>
              </div>
            </div>
          </div>
          <div class="content">
            <div class="title">CONSENT TO SURGERY OR SPECIAL PROCEDURE</div>

            <p>
              I,
              <span class="field-container">
                <span class="field-text designeeName"></span>
                <span class="field-label">(Name of patient or Designee)</span>
              </span>
              have been asked to read all the information contained in this consent form and to consent to the procedure described below on behalf of
              <span class="field-container">
                <span class="field-text consentForName"></span>
                <span class="field-label">(Name of Patient)</span>
              </span>
              or myself. I have been told that I should ask questions about anything that I do not understand. (If the decision‑maker signing this form is not the patient, references to “I,” “my” or “me” should be read as if referring to “the patient.”)
            </p>

            <p>
              I understand that the information in this consent form, in addition to discussions with my physicians and any other written materials they may provide, is intended to help me make an informed decision whether to voluntarily undergo the identified procedure.
            </p>

            <p><strong>Diagnosis:</strong> I understand that after being examined, treated, and having studies reviewed, I have been diagnosed as having:</p>
            <div class="dash" id="p1_diagnosis" style="min-height:0.5rem"></div>

            <p><strong>Recommended Procedure:</strong> I understand that my physician(s) have recommended that I undergo a procedure known as</p>
            <div class="dash" id="p1_recommended"></div>
            <p>I understand that a series of the described procedure(s) in the operating room are planned.</p>

            <p><strong>Alternatives.</strong> I understand that I may choose NOT to undergo the Recommended Treatment. I acknowledge that my physician(s) or physician representative has described the alternative treatments, the risks and benefits of the alternative treatments, the likelihood of me achieving my goals; any potential problems that might occur during recuperation and the likely medical results should I decide not to undergo the recommended procedure. These treatment alternatives may include:</p>
            <div class="dash" id="p1_alternatives" style="min-height:0.5rem"></div>

            <p><strong>Risks of Surgery.</strong> I understand that there are inherent risks in the performance of the recommended procedure. These include:</p>
            <ol class="ol">
              <li><strong>Bleeding:</strong> If needed, blood and/or blood products have the following general risks: reactions resulting in itching, rash, fever, chills, headache, or shock; respiratory distress (shortness of breath); kidney damage; systemic bacterial infection; exposure to blood borne viruses including hepatitis (an inflammatory disease affecting the liver) and Human Immunodeficiency Virus (HIV, the virus that causes AIDS); and death. Alternatives to transfusion include the use of devices that filter and return blood lost in surgery to me or by providing medications that boost my blood count prior to an elective procedure. Bleeding and/or severe anemia could put my life in danger or cause permanent brain damage. I understand that substitutes for blood or plasma might not work well enough. Blood and/or blood products might offer the only chance to preserve my life.</li>
            </ol>
            <p>I refuse the transfusion of blood and/or blood products and understand that I will be asked to sign a separate form entitled Release from Liability for the Refusal of Blood Transfusion.</p>

            <p style="margin-bottom:0">If my procedure is to be performed in an Ambulatory Surgical Facility (ASF), the comparative risks, benefits and alternatives associated with performing the procedure in the ASF instead of a hospital have been fully explained to me. I understand the hospital may require that all jewelry and/or body piercing hardware be</p>
          </div>
          <div class="footer">
            <img class="barcode" src="Hh6nBGq.png" alt="barcode" />
            <div class="foot-date">2/16/2024</div>
          </div>
        </div>

        <!-- PAGE 2 -->
        <div class="sheet" style="margin-top:1rem">
          <div class="header">
            <div class="hdr">
              <div class="hdr-left">
                <div class="pageNo">Page 2 of 4</div>
                <img class="logo" src="gTlSit7.png" alt="UPMC" />
              </div>
              <div class="hdr-right">
                <div><strong>Patient Name:</strong> <span class="hdrPatientName line"></span></div>
                <div><strong>Identification Number:</strong> <span class="hdrId line"></span></div>
                <div><strong>Date of Birth:</strong> <span class="hdrDob line"></span></div>
                <div><strong>Facility:</strong> <span class="hdrFacility line"></span></div>
              </div>
            </div>
          </div>
          <div class="content">
            <div class="title">CONSENT TO SURGERY OR SPECIAL PROCEDURE</div>

            <p>removed prior to surgery.</p>
            <ol class="ol" start="2">
              <li>Infection: This may occur at the site of surgery or elsewhere depending upon procedure performed.</li>
              <li>Injury to adjacent organs.</li>
              <li>Pain. This should resolve within a few days but may be prolonged.</li>
              <li>As with all surgeries, there is a risk of heart attack, stroke, multisystem organ failure, reactions to medications, and death, even in healthy patients.</li>
              <li>Blood clots. These clots usually develop in the legs and can break free and move through the heart to the lungs. In the lungs, they can cause serious interference with breathing, which can lead to death. Blood clots are treated with blood‑thinning drugs that may need to be taken for an extended period of time.</li>
              <li>Nerve damage surrounding the surgical site or Damage to nerves from pressure or positioning of the arms, legs or back during the surgery. Nerve damage can cause numbness, weakness, paralysis and/or pain. In most cases these symptoms are temporary, but in rare cases they can last for extended periods or even permanently.</li>
              <li>Burns caused by use of electrical equipment that may be needed to stop bleeding or by other equipment.</li>
              <li>Wound dehiscence.</li>
              <li>Prolonged hospitalization.</li>
              <li>Other risks:</li>
            </ol>
            <div class="dash" id="p2_otherRisks" style="min-height:3rem"></div>

            <p><strong>Teaching Facility and Overlapping Surgeries:</strong> I understand that the facility is a teaching facility. The health care team may include residents, fellows, students, and skilled healthcare professionals. Credentialed team members may perform all or parts of my procedure under the supervision and guidance of my physician(s). My attending physician may also be caring for one other patient during my surgery but remains responsible to me and will perform or be present for the key portions of the procedure. If unanticipated circumstances require my surgeon to be unavailable during my surgery, another qualified surgeon will promptly come to the operating room. Representatives of medical device companies may be present to provide devices and observe and advise on their use. Who will participate and in what manner will be decided at the time of the procedure and will depend on the availability of individuals with the necessary expertise and on my medical condition.</p>

            <p>If an accidental exposure to my blood or body fluids occurs to staff during the surgery or procedure, I agree to blood tests for hepatitis B, hepatitis C and HIV.</p>

            <p>I understand that the physician(s) or others may choose to photograph, televise, film, or otherwise record all or any portion of my procedure for medical, scientific, or educational purposes. I consent to the photographing, televising, filming, or other forms of recording of the procedure(s) to be performed, including appropriate portions of my body, body functions or sounds, provided my identity is not revealed. I understand and agree that 1) any photographs, films, or other audio or visual recordings created will be the sole property of the facility: and 2) the facility or any appropriate staff member may edit, preserve, or destroy all or any part of the</p>
          </div>
          <div class="footer">
            <img class="barcode" src="Hh6nBGq.png" alt="barcode" />
            <div class="foot-date">2/16/2024</div>
          </div>
        </div>

        <!-- PAGE 3 -->
        <div class="sheet" style="margin-top:1rem">
          <div class="header">
            <div class="hdr">
              <div class="hdr-left">
                <div class="pageNo">Page 3 of 4</div>
                <img class="logo" src="gTlSit7.png" alt="UPMC" />
              </div>
              <div class="hdr-right">
                <div><strong>Patient Name:</strong> <span class="hdrPatientName line"></span></div>
                <div><strong>Identification Number:</strong> <span class="hdrId line"></span></div>
                <div><strong>Date of Birth:</strong> <span class="hdrDob line"></span></div>
                <div><strong>Facility:</strong> <span class="hdrFacility line"></span></div>
              </div>
            </div>
          </div>
          <div class="content">
            <div class="title">CONSENT TO SURGERY OR SPECIAL PROCEDURE</div>

            <p>photographs, films, or other audio or visual recordings. Such recordings are not part of the medical record and I understand I cannot obtain a copy.</p>

            <p>I authorize the disposal or retention, preservation, testing, or use for scientific, educational, or other purposes of all or any portion of specimens, tissues, body parts, or other things, including prostheses and medical/surgical appliances, that may be removed from my body.</p>

            <p>I understand that if any medical device, as defined by federal regulations, is implanted in a patient’s body, the facility is required by law to report to the manufacturer the name, address and social security number of the patient and the description and identity of the device.</p>

            <p style="font-weight:700">MY SIGNATURE BELOW ACKNOWLEDGES THAT:</p>
            <ol class="ol">
              <li>I have read (or had read to me), understand and agree to the statements set forth in this consent form.</li>
              <li>A physician or representative has explained to me all information referred to in this consent form. I have had an opportunity to ask questions and my questions have been answered to my satisfaction, including any question I have about the potential use of blood and/or blood products and any risks regarding their use.</li>
              <li>All statements requiring completion were filled in before I signed.</li>
              <li>No guarantees or assurances concerning the results of the procedure(s) have been made.</li>
              <li>I am signing this consent voluntarily. I am not signing due to any coercion or other influence.</li>
              <li>I hereby consent and authorize Dr. <span class="inlineLine physicianName"></span> (my physician(s)) and/or those associates, assistants and other health care providers designated by my physician(s) to perform the recommended procedure described above. I understand that during the procedure, conditions may become apparent that require my physicians or their designees to take steps or perform additional procedures that they believe are medically necessary to achieve the desired benefits or for my well‑being.</li>
              <li>I authorize and request my physician(s) or their designees to perform whatever medical acts or additional procedures they, in the exercise of their sole professional judgment, deem reasonable and necessary, and I waive any obligation on their part to stop or delay the continuation of my procedure to obtain additional consent if I am unable to give additional consent at that time.</li>
            </ol>
          </div>
          <div class="footer">
            <img class="barcode" src="Hh6nBGq.png" alt="barcode" />
            <div class="foot-date">2/16/2024</div>
          </div>
        </div>

        <!-- PAGE 4 -->
        <div class="sheet" style="margin-top:1rem">
          <div class="header">
            <div class="hdr">
              <div class="hdr-left">
                <div class="pageNo">Page 4 of 4</div>
                <img class="logo" src="gTlSit7.png" alt="UPMC" />
              </div>
              <div class="hdr-right">
                <div><strong>Patient Name:</strong> <span class="hdrPatientName line"></span></div>
                <div><strong>Identification Number:</strong> <span class="hdrId line"></span></div>
                <div><strong>Date of Birth:</strong> <span class="hdrDob line"></span></div>
                <div><strong>Facility:</strong> <span class="hdrFacility line"></span></div>
              </div>
            </div>
          </div>
          <div class="content">
            <div class="title">CONSENT TO SURGERY OR SPECIAL PROCEDURE</div>

            <!-- Signature section redesigned to eliminate double underlines and use flexible layout -->
            <div class="signature-section" style="margin-bottom:.25in">
              <!-- Witness row: Date, Time, Witness -->
              <div class="signature-row">
                <div class="sig-field">
                  <span>Date:</span>
                  <!-- Use a single element for the blank line.  Nesting a span inside
                       another span that draws a border results in two parallel
                       underlines.  Assign the witnessDate class directly to
                       the underlined element so the script can fill it. -->
                  <span class="uline u-date-time witnessDate"></span>
                </div>
                <div class="sig-field">
                  <span>Time:</span>
                  <span class="uline u-date-time witnessTime"></span>
                </div>
                <div class="sig-field flex-grow" style="justify-content:space-between;">
                  <span>Witness</span>
                  <span class="uline u-med witnessName"></span>
                </div>
              </div>
              <!-- Patient signature row: Date, Time, Signature -->
              <div class="signature-row">
                <div class="sig-field">
                  <span>Date:</span>
                  <span class="uline u-date-time signerDate"></span>
                </div>
                <div class="sig-field">
                  <span>Time:</span>
                  <span class="uline u-date-time signerTime"></span>
                </div>
                <div class="sig-field flex-grow" style="justify-content:space-between;">
                  <span>Signature of patient or person authorized to consent for patient</span>
                  <!-- leave blank for signature line; no class needed -->
                  <span class="uline u-med"></span>
                </div>
              </div>
              <!-- Relationship row -->
              <div class="signature-row">
                <div class="sig-field flex-grow" style="justify-content:space-between;">
                  <span>Relationship to patient if signer is not Patient:</span>
                  <span class="uline u-rel signerRel"></span>
                </div>
              </div>
            </div>

            <!-- Physician statement and signature block -->
            <!-- Remove the top border here to avoid creating an extra horizontal line after the
                 patient/relationship rows. We leave padding to separate the sections. -->
            <div style="padding-top:.2in;margin-bottom:.25in">
              <p>I have explained to the patient signing above all the information referred to in this consent form. I have given no guarantee or assurance as to the results that may be obtained.</p>
              <!-- Physician signature rows using flexible layout -->
              <div class="signature-row">
                <div class="sig-field">
                  <span>Date</span>
                  <span class="uline u-date-time physDate"></span>
                </div>
                <div class="sig-field">
                  <span>Time</span>
                  <span class="uline u-date-time physTime"></span>
                </div>
                <div class="sig-field flex-grow" style="justify-content:space-between;">
                  <span>Signature of Physician or Representative</span>
                  <span class="uline u-med"></span>
                </div>
              </div>
              <div class="signature-row">
                <div class="sig-field flex-grow" style="justify-content:space-between;">
                  <span>Printed name</span>
                  <span class="uline u-rel physName"></span>
                </div>
              </div>
            </div>

            <div style="border-top:1px solid #000;padding-top:.2in">
              <div style="font-weight:700">INTERPRETER’S STATEMENT</div>
              <p>Execute if an interpreter is provided to assist the individual in understanding this informed consent form:</p>
              <p>I have translated the information and advice presented orally to the individual to be treated by the person obtaining this consent.</p>
              <p>In addition, I have sight translated the consent form (read it aloud in his/her language). To the best of my knowledge and belief he/she understood this explanation.</p>
              <div class="list" style="font-size:10pt">
                <div><strong>Cyracom ID (if applicable)</strong>: <span class="uline u-short cyracom"></span></div>
                <div><strong>Print Name</strong>: <span class="uline u-rel interpName"></span></div>
                <div><strong>Signature</strong>: <span class="uline u-wide"></span> <span class="muted" style="font-size:9pt">(Not required if a Cyracom Interpreter Was Used)</span></div>
              </div>
            </div>
          </div>
          <div class="footer">
            <img class="barcode" src="Hh6nBGq.png" alt="barcode" />
            <div class="foot-date">2/16/2024</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const BLANK = (n=20) => '_'.repeat(n);
    const uniq = (arr) => Array.from(new Set((arr||[]).filter(Boolean).map(s => s.trim())));

    function joinNames(arr){
      if(!arr||arr.length===0) return '';
      if(arr.length===1) return arr[0];
      if(arr.length===2) return arr.join(' and ');
      return arr.slice(0,-1).join(', ')+', and '+arr[arr.length-1];
    }

    // ---------- State & persistence ----------
    const defaults = { selectedProcKeys: [], selectedSurgeons: [], laterality: {} };
    let f = {...defaults};
    let catalog = [];
    let surgeons = [];

    const DEFAULT_PROCEDURES = [
      {
        key:'TandA',
        name:'Tonsillectomy ± Adenoidectomy',
        risks:['post-operative hemorrhage','dehydration','voice change/velopharyngeal insufficiency','dental or lip injury','infection','pain'],
        // Generic alternatives for tonsillectomy/adenoidectomy
        alternatives:['Observation (watchful waiting)','Medical therapy (antibiotics, steroids)']
      },
      {
        key:'BMT',
        name:'Bilateral Myringotomy with Tympanostomy Tubes',
        risks:['otorrhea','premature tube extrusion or retention','persistent tympanic membrane perforation','hearing changes','need for further procedures'],
        alternatives:['Observation','Antibiotic therapy']
      },
      {
        key:'FESS',
        name:'Functional Endoscopic Sinus Surgery',
        risks:['cerebrospinal fluid leak','orbital injury including diplopia or vision loss','bleeding','adhesions/scar formation','recurrence requiring revision','altered sense of smell'],
        alternatives:['Medical therapy (steroid sprays, saline rinses)','Allergy management']
      },
      {
        key:'SEPT',
        name:'Septoplasty',
        risks:['septal perforation','persistent nasal obstruction','epistaxis','dental or upper-lip numbness','cosmetic change (e.g., saddle nose)'],
        alternatives:['Medical management','Nasal decongestants']
      },
      {
        key:'ITR',
        name:'Inferior Turbinate Reduction',
        risks:['bleeding','crusting/dryness','infection','empty nose syndrome (rare)','need for revision'],
        alternatives:['Medical management','Allergy management']
      },
      {
        key:'DLB',
        name:'Direct Laryngoscopy and Bronchoscopy',
        risks:['dental injury','airway trauma','laryngospasm/bronchospasm','hypoxia','need for intubation or hospital admission'],
        alternatives:['Imaging studies (CT, MRI)','Noninvasive diagnostic tests']
      },
      {
        key:'NECK',
        name:'Neck Mass Excision',
        risks:['nerve injury (e.g., marginal mandibular, spinal accessory)','seroma/hematoma','infection','scarring'],
        alternatives:['Biopsy or fine-needle aspiration','Observation','Radiologic monitoring'],
        // This procedure is side‑specific (e.g., left or right).  Setting
        // requiresLaterality=true triggers the UI to request laterality.
        requiresLaterality:true
      },
    ];

    function load(){
      try{ f = JSON.parse(localStorage.getItem('consent-html-state')||'{}') }catch{ f={} }
      f = {...defaults, ...f};
      try{ catalog = JSON.parse(localStorage.getItem('consent-proc-catalog-html')||'null') || DEFAULT_PROCEDURES }catch{ catalog = DEFAULT_PROCEDURES }
      try{ surgeons = JSON.parse(localStorage.getItem('consent-surgeons-html')||'[]') }catch{ surgeons = [] }
    }
    function save(){
      localStorage.setItem('consent-html-state', JSON.stringify(f));
      localStorage.setItem('consent-proc-catalog-html', JSON.stringify(catalog));
      localStorage.setItem('consent-surgeons-html', JSON.stringify(surgeons));
    }

    // Track manual edits to avoid overwriting auto text
    const touched = { rec:false, risks:false, alts:false };

    // ---------- Rendering: left controls ----------
    function renderSurgeons(){
      const box = $('#surgeonList');
      box.innerHTML = '';
      surgeons.forEach(name => {
        const id = 'surg_'+name.replace(/[^a-z0-9]+/gi,'_');
        const wrap = document.createElement('label');
        wrap.className = 'check';
        wrap.innerHTML = `<input type="checkbox" id="${id}"> <span>${name}</span>`;
        const cb = wrap.querySelector('input');
        cb.checked = (f.selectedSurgeons||[]).includes(name);
        cb.addEventListener('change', () => {
          const set = new Set(f.selectedSurgeons||[]);
          if(cb.checked) set.add(name); else set.delete(name);
          f.selectedSurgeons = Array.from(set);
          updateDerived(); save(); renderPreview(); renderReview();
        });
        box.appendChild(wrap);
      });
    }

    function renderProcedures(){
      const list = $('#procList');
      list.innerHTML = '';
      catalog.forEach(p => {
        const id = 'proc_'+p.key;
        const el = document.createElement('label');
        el.className = 'check';
        el.innerHTML = `<input type="checkbox" id="${id}"> <div><div style="font-weight:600">${p.name}</div>${p.risks && p.risks.length? `<div class="muted" style="font-size:.8rem">Risks: ${p.risks.join(', ')}</div>`:''}</div>`;
        const cb = el.querySelector('input');
        cb.checked = (f.selectedProcKeys||[]).includes(p.key);
        cb.addEventListener('change', () => {
          const set = new Set(f.selectedProcKeys||[]);
          if(cb.checked) set.add(p.key); else set.delete(p.key);
          f.selectedProcKeys = Array.from(set);
          updateDerived(); save(); renderPreview(); renderReview();
        });
        list.appendChild(el);
      });
    // After rendering procedures, update the laterality controls
    renderLaterality();
    }

  // Render laterality selectors for procedures that require it
  function renderLaterality(){
    const container = document.getElementById('lateralitySection');
    if(!container) return;
    // Clear previous controls
    container.innerHTML = '';
    // Determine selected procedures that require laterality
    const selectedProcs = (f.selectedProcKeys||[]).map(key => catalog.find(p=>p && p.key===key)).filter(Boolean);
    selectedProcs.forEach(proc => {
      if(proc.requiresLaterality){
        const row = document.createElement('div');
        row.className = 'laterality-row';
        // label and select control
        const selId = 'lat_'+proc.key;
        row.innerHTML = `<label style="font-size:.8rem;margin-right:.25rem">${proc.name} laterality:</label>`;
        const select = document.createElement('select');
        select.id = selId;
        select.style.marginLeft = '0.25rem';
        ['','Left','Right','Bilateral'].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt ? opt : 'Select...';
          select.appendChild(option);
        });
        // Set current selection
        if(f.laterality && f.laterality[proc.key]){
          select.value = f.laterality[proc.key];
        }
        // Update laterality on change
        select.addEventListener('change', () => {
          if(!f.laterality) f.laterality = {};
          f.laterality[proc.key] = select.value || '';
          // Save and update derived fields
          save(); updateDerived(); renderPreview(); renderReview();
        });
        row.appendChild(select);
        container.appendChild(row);
      }
    });
    container.style.display = container.children.length ? 'block' : 'none';
  }

    // Inputs bind
    function bindInputs(){
      document.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
        const k = el.dataset.field;
        el.value = f[k] || '';
        el.addEventListener('input', () => {
          f[k] = el.value;
          // When the signer date changes, automatically propagate that value to
          // the witness and physician dates.  This keeps all signature dates
          // consistent without requiring the user to re‑enter them in
          // multiple places.  We update both the persisted state and the
          // corresponding input elements so the form reflects the change
          // immediately.
          if(k === 'signerDate') {
            f.witnessDate = el.value;
            f.physSigDate = el.value;
            const wInput = document.getElementById('witnessDate');
            if(wInput) wInput.value = el.value;
            const pInput = document.getElementById('physSigDate');
            if(pInput) pInput.value = el.value;
          }
          if(k==='recommendedProcedure') touched.rec = true;
          if(k==='otherRisks') touched.risks = true;
          if(k==='alternatives') touched.alts = true;
          save(); renderPreview(); renderReview();
        });
      });
    }

    // Add surgeon
    $('#addSurgeonBtn').addEventListener('click', () => {
      const v = $('#newSurgeon').value.trim(); if(!v) return;
      if(!surgeons.includes(v)) surgeons.push(v);
      $('#newSurgeon').value='';
      save(); renderSurgeons(); updateDerived(); renderPreview(); renderReview();
    });
    $('#newSurgeon').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#addSurgeonBtn').click(); }});

    // Add procedure
    $('#addProcBtn').addEventListener('click', () => {
      const name = $('#procName').value.trim(); if(!name) return;
      const risksCsv = $('#procRisks').value;
      const altsCsv = $('#procAlts').value;
      const risks = uniq(risksCsv.split(/[\n,]/));
      const alternatives = uniq(altsCsv.split(/[\n,]/));
      const key = (name.toUpperCase().replace(/[^A-Z0-9]+/g,'-') + '-' + Math.random().toString(36).slice(2,7).toUpperCase());
      const lateralityRequired = $('#procLaterality').checked;
      catalog.push({key, name, risks, alternatives, requiresLaterality: lateralityRequired});
      // reset input fields
      $('#procName').value=''; $('#procRisks').value=''; $('#procAlts').value=''; $('#procLaterality').checked = false;
      save(); renderProcedures(); updateDerived(); renderPreview(); renderReview();
    });

    // Buttons
    $('#printBtn').addEventListener('click', () => window.print());
    $('#resetBtn').addEventListener('click', () => { localStorage.clear(); location.reload(); });
    $('#copyBtn').addEventListener('click', async () => {
      try{ await navigator.clipboard.writeText($('#reviewBox').value) }catch{}
    });

    // ======== Customizable section for additional procedures and surgeons ========
    // Add new procedures to the array below. Each entry should have a unique `key`, a
    // human‑readable `name`, an array of `risks`, and an array of `alternatives`.
    // Example:
    // { key:'CHOL', name:'Cholecystectomy', risks:['bleeding','infection'], alternatives:['Observation','Medical therapy'] }
    const ADDITIONAL_PROCEDURES = [
      // Add your custom procedure objects here
    ];
    // Add new surgeon surnames to the array below (plain strings).
    // Example: 'Smith', 'Jones'
    const ADDITIONAL_SURGEONS = [
      // Add your custom surgeon names here
    ];

    // After loading defaults and any saved data, append custom entries. This function
    // is called during initialization (see the init section below).
    function appendCustom(){
      if(ADDITIONAL_PROCEDURES && ADDITIONAL_PROCEDURES.length){
        catalog = catalog.concat(ADDITIONAL_PROCEDURES.filter(p => p && p.key));
      }
      if(ADDITIONAL_SURGEONS && ADDITIONAL_SURGEONS.length){
        surgeons = surgeons.concat(ADDITIONAL_SURGEONS.filter(Boolean));
      }
    }

    // ---------- Derived text (auto) ----------
    function updateDerived(){
      const selectedProcs = (f.selectedProcKeys||[]).map(key => catalog.find(p=>p && p.key===key)).filter(Boolean);
      // Build names including laterality if required
      const namesWithLat = selectedProcs.map(p => {
        // Prepend laterality to the procedure name when specified.  For example,
        // "Left" + "Neck Mass Excision" becomes "Left Neck Mass Excision".
        let nm = p.name;
        if(p.requiresLaterality){
          const lat = f.laterality && f.laterality[p.key];
          if(lat){ nm = `${lat} ${p.name}`; }
        }
        return nm;
      });
      // Compose recommended procedure string
      let autoRecommended = '';
      if(namesWithLat.length===1){ autoRecommended = namesWithLat[0]; }
      else if(namesWithLat.length===2){ autoRecommended = namesWithLat.join(' and '); }
      else if(namesWithLat.length>2){ autoRecommended = namesWithLat.slice(0,-1).join('; ') + '; and ' + namesWithLat[namesWithLat.length-1]; }
      // Collect and normalize risks to deduplicate across case/spacing
      const allRisks = selectedProcs.flatMap(p=>p.risks||[]).filter(Boolean);
      const riskMap = {};
      allRisks.forEach(risk => {
        const norm = risk.toLowerCase().trim();
        if(!riskMap[norm]) riskMap[norm] = risk.trim();
      });
      const autoRisks = Object.values(riskMap);
      const autoOtherRisks = autoRisks.length ? ('Procedure-specific risks: ' + autoRisks.join(', ') + '.') : '';
      if(!touched.rec) f.recommendedProcedure = autoRecommended;
      if(!touched.risks) f.otherRisks = autoOtherRisks;
      // Physician from surgeons
      const joined = joinNames(f.selectedSurgeons||[]);
      f.physicianName = joined || f.physicianName || '';
      save();
      // reflect in inputs if untouched
      if(!touched.rec){ const el=document.getElementById('recommendedProcedure'); if(el) el.value=f.recommendedProcedure||''; }
      if(!touched.risks){ const el=document.getElementById('otherRisks'); if(el) el.value=f.otherRisks||''; }
      // Auto-populate alternatives from selected procedures
      const autoAlts = uniq(selectedProcs.flatMap(p=>p.alternatives||[]));
      const autoAltString = autoAlts.length? autoAlts.join(', ') : '';
      if(!touched.alts) f.alternatives = autoAltString;
      if(!touched.alts){ const el=document.getElementById('alternatives'); if(el) el.value=f.alternatives||''; }
      // Refresh laterality controls when procedures change
      renderLaterality();
    }

    // ---------- Rendering: print side ----------
    function setLine(sel, txt, len=18){ document.querySelectorAll(sel).forEach(el => el.textContent = (txt && txt.trim())? txt : '_'.repeat(len)); }
    function setBlock(id, txt){ const el=document.querySelector(id); if(el) el.textContent = txt||''; }

    function renderPreview(){
      setLine('.hdrPatientName', f.patientName, 20);
      setLine('.hdrId', f.idNumber, 12);
      setLine('.hdrDob', f.dob, 12);
      setLine('.hdrFacility', f.facility, 12);

      // Populate witness name, date and time on the signature section (page 4)
      setLine('.witnessName', f.witnessName, 24);
      setLine('.witnessDate', f.witnessDate, 12);
      setLine('.witnessTime', f.witnessTime, 10);

      setLine('.designeeName', f.designeeName, 28);
      const patientNameForProcedure = (f.consentForName && f.consentForName.trim())? f.consentForName : (f.patientName||'');
      setLine('.consentForName', patientNameForProcedure, 28);

      setBlock('#p1_diagnosis', f.diagnosis||'');
      setBlock('#p1_recommended', f.recommendedProcedure||'');
      setBlock('#p1_alternatives', f.alternatives||'');
      setBlock('#p2_otherRisks', f.otherRisks||'');

      setLine('.physicianName', f.physicianName, 24);
      setLine('.signerDate', f.signerDate, 12);
      setLine('.signerTime', f.signerTime, 10);
      setLine('.signerRel', f.signerRelationship, 22);
      setLine('.physDate', f.physSigDate, 12);
      setLine('.physTime', f.physSigTime, 10);
      // Do not fall back to the selected surgeon list for the printed
      // physician/representative name.  This line should remain blank unless
      // the user enters a printed name in the "Physician/Representative" field.
      setLine('.physName', f.physSigName, 24);
      setLine('.cyracom', f.cyracom, 14);
      setLine('.interpName', f.interpName, 24);
    }

    // ---------- Review text ----------
    function renderReview(){
      const review = (
`Patient: ${f.patientName||''} (MRN ${f.idNumber||''}${f.dob?`, DOB ${f.dob}`:''})
Facility: ${f.facility||''}

Procedures: ${f.recommendedProcedure||'(none)'}

Diagnosis: ${f.diagnosis||''}
Alternatives: ${f.alternatives||''}
Other risks: ${f.otherRisks||''}

Surgeon(s): ${f.physicianName||''}`.trim());
      document.getElementById('reviewBox').value = review;
    }

    // ---------- Init ----------
    load();
    // Append any custom procedures or surgeon surnames defined below
    appendCustom();
    renderSurgeons();
    renderProcedures();
    bindInputs();
    updateDerived();
    renderPreview();
    renderReview();
  </script>
</body>
</html>
